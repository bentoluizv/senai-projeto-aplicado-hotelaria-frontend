---
import { actions } from "astro:actions";
import LoginLayout from "../layouts/LoginLayout.astro";

const tokenCookie = Astro.cookies.get("token");
console.log("LOGIN 1 PAGE LOAD: Cookie?", tokenCookie);

if (tokenCookie) {
  const token = tokenCookie.json();
  const { data, error } = await Astro.callAction(
    actions.refreshTokenAction,
    token
  );

  if (!error) {
    return Astro.redirect("/");
  }
}

if (Astro.request.method === "POST") {
  const formData = await Astro.request.formData();
  const { data, error } = await Astro.callAction(actions.loginAction, formData);
  console.log("LOGIN 2 POST METHOD: Cookie?", Astro.cookies.get("token"));

  if (error) {
    console.error("Oops, there was a problem in you login attempt!!", error);

    return Astro.redirect("/login");
  } else {
    console.log("O cookie via para / ? ->", Astro.cookies.has("token"));
    console.log("REDIRECIONANDO PARA /");

    return Astro.redirect("/");
  }
}
---

<LoginLayout>
  <form
    method="POST"
    class="bg-zinc-800/90 text-amber-50 shadow-lg rounded-lg p-8 space-y-6 w-full max-w-md z-10">
    <h1 aria-hidden="true" hidden class="text-2xl font-bold text-center mb-6">
      Fa√ßa seu login
    </h1>

    <div>
      <label for="username" class="block text-sm font-medium text-amber-50">
        E-mail
      </label>
      <input
        type="text"
        id="username"
        name="username"
        required
        minlength="3"
        class="mt-1 block w-full rounded-lg border border-gray-300 bg-white text-zinc-800 py-2 px-4 shadow-sm focus:border-amber-500 focus:ring-2 focus:ring-amber-500 placeholder-zinc-400"
        placeholder="seuemail@email.com"
      />
    </div>

    <div>
      <label for="password" class="block text-sm font-medium text-amber-50">
        Senha
      </label>
      <input
        type="password"
        id="password"
        name="password"
        required
        minlength="6"
        class="mt-1 block w-full rounded-lg border border-gray-300 bg-white text-zinc-800 py-2 px-4 shadow-sm focus:border-amber-500 focus:ring-2 focus:ring-amber-500 placeholder-zinc-400"
        placeholder="Insira sua senha"
      />
    </div>

    <button
      type="submit"
      class="w-full bg-amber-400 text-zinc-800 font-bold py-2 px-4 rounded-md hover:bg-amber-700 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-offset-2">
      Login
    </button>
  </form>
</LoginLayout>
